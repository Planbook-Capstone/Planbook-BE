name: Deploy Spring Boot Backend with Docker Compose (Local Build)

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # Bước này cần thiết để tạo ra file JAR
      - name: Maven Clean and Package
        run: mvn clean package -DskipTests

      # Bước này tạo file docker-compose.yml động trên runner
      - name: Create docker-compose.yml on runner
        run: |
          cat <<EOF > docker-compose.yml
          version: '3.8'

          services:
            zookeeper:
              image: zookeeper:latest
              container_name: zookeeper
              restart: always
              ports:
                - "2181:2181"
              environment:
                # Xóa ZOO_MY_ID và ZOO_SERVERS khi chỉ chạy 1 node Zookeeper độc lập
                # ZOO_SERVERS gây nhầm lẫn và có thể khiến Zookeeper không lắng nghe đúng cổng client.
                ZOO_CLIENT_PORT: 2181 # Chỉ định rõ cổng client cho Zookeeper
                # Nếu bạn thực sự cần ZOO_MY_ID cho mục đích logging hoặc giám sát, có thể giữ lại,
                # nhưng ZOO_SERVERS cần phải loại bỏ khi ở chế độ standalone.

            kafka:
              image: confluentinc/cp-kafka:7.5.0
              container_name: kafka
              restart: always
              ports:
                - "9092:9092"
              environment:
                KAFKA_BROKER_ID: 1
                KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
                KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
                KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
                KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
                KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
              depends_on:
                - zookeeper

            kafdrop:
              image: obsidiandynamics/kafdrop:latest
              container_name: kafdrop
              restart: always
              ports:
                - "9000:9000"
              environment:
                KAFKA_BROKERCONNECT: kafka:29092
                JVM_OPTS: "-Xms16M -Xmx48M"
              depends_on:
                - kafka

            redis:
              image: redis:latest
              container_name: redis
              restart: always
              ports:
                - "6379:6379"

            backend:
              # SỬ DỤNG 'build' ĐỂ BUILD IMAGE TRÊN VPS
              build:
                context: . # context là thư mục hiện tại (khi docker compose chạy trên VPS)
                dockerfile: Dockerfile
              image: planbook-be:latest # Đặt tên tag cho image cục bộ trên VPS
              container_name: backend-app
              restart: always
              ports:
                - "8080:8080"
              environment:
                SPRING_DATASOURCE_URL: "${{ secrets.DB_URL }}"
                SPRING_DATASOURCE_USERNAME: "${{ secrets.DB_USERNAME }}"
                SPRING_DATASOURCE_PASSWORD: "${{ secrets.DB_PASSWORD }}"
                SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: "org.hibernate.dialect.MySQL8Dialect"
                SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
                SPRING_MAIN_ALLOW_CIRCULAR_REFERENCES: "true"
                SPRING_MVC_PATHMATCH_MATCHING_STRATEGY: "ANT_PATH_MATCHER"
                SUPABASE_JWT_SECRET: "${{ secrets.SUPABASE_JWT_SECRET_KEY }}"
                SPRING_SECRETKEY: "${{ secrets.SPRING_APP_SECRET_KEY }}"
                SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:29092"
                KAFKA_TOPIC_NAME: "${{ secrets.KAFKA_TOPIC }}"
                SPRING_MAIL_HOST: "${{ secrets.MAIL_HOST }}"
                SPRING_MAIL_PORT: "${{ secrets.MAIL_PORT }}"
                SPRING_MAIL_USERNAME: "${{ secrets.MAIL_USERNAME }}"
                SPRING_MAIL_PASSWORD: "${{ secrets.MAIL_PASSWORD }}"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED: "true"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_CONNECTIONTIMEOUT: "5000"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_TIMEOUT: "5000"
                SPRING_MAIL_PROPERTIES_MAIL_SMTP_WRITETIMEOUT: "5000"
                SPRING_MAIL_DEFAULT_ENCODING: "UTF-8"
                SPRING_DATA_REDIS_HOST: "redis"
                SPRING_DATA_REDIS_PORT: "6379"
                SPRING_CACHE_TYPE: "redis"
                SPRING_DURATION: "${{ secrets.APP_DURATION }}"
                SPRING_PROFILES_ACTIVE: "prod"
              depends_on:
                - zookeeper
                - kafka
                - redis
          EOF
        shell: bash

      # Bước này copy tất cả file cần thiết lên VPS
      - name: Copy Project Files to VPS
        uses: appleboy/scp-action@v0.1.7 # Vẫn sử dụng phiên bản cũ
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "." # Copy toàn bộ thư mục hiện tại lên VPS
          target: /var/www/be/

      # Bước này dừng và xóa các container cũ
      - name: Stop and Remove Old Containers on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/be || { echo "Error: /var/www/be directory not found on VPS."; exit 1; }
            echo "Stopping and removing old Docker Compose services..."

            # NEW: Kill bất kỳ tiến trình nào đang sử dụng cổng 8080 để đảm bảo nó trống
            echo "Checking and freeing up port 8080..."
            PORT_TO_FREE=8080
            # Lấy PID của tiến trình đang sử dụng cổng
            PID_ON_PORT=$(sudo lsof -t -i :$PORT_TO_FREE)
            if [ -n "$PID_ON_PORT" ]; then
              echo "Found process on port $PORT_TO_FREE with PID: $PID_ON_PORT. Attempting to kill it..."
              # Giết tiến trình một cách cưỡng bức. 2>/dev/null để ẩn lỗi nếu tiến trình đã chết.
              sudo kill -9 $PID_ON_PORT 2>/dev/null || true
              # Đợi một chút để cổng được giải phóng hoàn toàn
              sleep 1
              if sudo lsof -i :$PORT_TO_FREE > /dev/null; then
                echo "Warning: Port $PORT_TO_FREE is still in use after killing process $PID_ON_PORT. Manual intervention may be needed."
              else
                echo "Port $PORT_TO_FREE is now free."
              fi
            else
              echo "Port $PORT_TO_FREE is already free."
            fi

            # 1. Thử down docker compose project nếu có. Thêm --timeout 0 để đảm bảo xóa bất chấp.
            # 2>/dev/null để ẩn các thông báo "No active containers" hoặc các cảnh báo khác nếu không có gì để down
            docker compose -f docker-compose.yml down -v --remove-orphans --timeout 0 2>/dev/null || true
            
            # 2. Xóa từng container CƯỠNG BỨC bằng tên của chúng, để đảm bảo không còn xung đột
            # CHỈ XÓA CÁC CONTAINER LIÊN QUAN ĐẾN BACKEND VÀ CÁC THÀNH PHẦN HỖ TRỢ
            # 2>/dev/null để ẩn các lỗi "No such container" nếu chúng không tồn tại
            echo "Attempting to forcefully stop and remove individual backend-related containers..."
            docker stop backend-app zookeeper kafka kafdrop redis 2>/dev/null || true
            docker rm -f backend-app zookeeper kafka kafdrop redis 2>/dev/null || true
            
            # 3. Xóa image của ứng dụng backend để đảm bảo build image mới nhất
            # 2>/dev/null để ẩn các lỗi "No such image" nếu image không tồn tại
            docker rmi planbook-be:latest 2>/dev/null || true
            
            echo "Old backend-related containers and images cleaned up."

      # Bước này khởi chạy ứng dụng mới
      - name: Start Application with Docker Compose on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/be || { echo "Error: /var/www/be directory not found on VPS."; exit 1; }
            echo "Building and starting new Docker Compose services..."
            
            # Đảm bảo các biến môi trường được export đúng cú pháp (dùng =)
            export SPRING_DATASOURCE_URL="${{ secrets.DB_URL }}"
            export SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}"
            export SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export SUPABASE_JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET_KEY }}"
            export SPRING_SECRETKEY="${{ secrets.SPRING_APP_SECRET_KEY }}"
            export KAFKA_TOPIC_NAME="${{ secrets.KAFKA_TOPIC }}"
            export SPRING_MAIL_HOST="${{ secrets.MAIL_HOST }}"
            export SPRING_MAIL_PORT="${{ secrets.MAIL_PORT }}"
            export SPRING_MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            export SPRING_MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            export SPRING_DATA_REDIS_HOST="${{ secrets.REDIS_HOST }}"
            export SPRING_DATA_REDIS_PORT="${{ secrets.REDIS_PORT }}"
            export SPRING_DURATION="${{ secrets.APP_DURATION }}"
            
            # Chạy Docker Compose up, chỉ định rõ file cấu hình
            docker compose -f docker-compose.yml up --build -d
            echo "Docker Compose services started. Check logs with 'docker compose logs -f backend-app'"
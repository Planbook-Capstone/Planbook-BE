name: Deploy Spring Boot Backend

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Maven Clean
        run: mvn clean

      - name: Maven Package (Skip Tests)
        run: mvn package -DskipTests

      - name: Get JAR file name
        id: get_jar_name
        run: |
          # Tìm tên file JAR đã build trong thư mục 'target'
          FULL_JAR_PATH=$(ls target/*.jar | head -1) # Lấy đường dẫn đầy đủ từ runner
          JAR_NAME=$(basename $FULL_JAR_PATH) # Lấy chỉ tên file (ví dụ: be.jar)
          echo "JAR_NAME=$JAR_NAME" >> $GITHUB_OUTPUT # Lưu TÊN FILE JAR vào output
          echo "FULL_JAR_PATH=$FULL_JAR_PATH" >> $GITHUB_OUTPUT # Lưu ĐƯỜNG DẪN ĐẦY ĐỦ vào output
          echo "Detected JAR path: $FULL_JAR_PATH"
          echo "Detected JAR name: $JAR_NAME"

      - name: Clean up old deployment on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/be || { echo "Error: /var/www/be directory not found on VPS."; exit 1; }
            echo "Performing deep cleanup on VPS before new copy..."
            PID=$(sudo lsof -t -i :8080)
            if [ -n "$PID" ]; then
              echo "Killing existing process on port 8080 (PID: $PID)"
              sudo kill -9 $PID
              sleep 5
            else
              echo "No existing process found on port 8080."
            fi
            sudo rm -rf *.jar target/ application.log # Xóa cả thư mục target cũ
            echo "Cleanup complete."

      - name: Copy JAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ steps.get_jar_name.outputs.FULL_JAR_PATH }} # Sử dụng đường dẫn đầy đủ từ runner
          target: /var/www/be/ # Copy thẳng vào thư mục này, scp-action sẽ tạo target/be.jar ở đây

      # === BƯỚC MỚI ĐƯỢC THÊM VÀO: DI CHUYỂN FILE JAR RA NGOÀI THƯ MỤC 'target' ===
      - name: Move JAR from target/ to root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/be || { echo "Error: /var/www/be directory not found on VPS."; exit 1; }
            echo "Moving JAR from target/ to /var/www/be/..."
            # Kiểm tra xem file JAR có trong target/ không
            if [ -f "target/${{ steps.get_jar_name.outputs.JAR_NAME }}" ]; then
              mv "target/${{ steps.get_jar_name.outputs.JAR_NAME }}" "./${{ steps.get_jar_name.outputs.JAR_NAME }}"
              echo "Successfully moved ${{ steps.get_jar_name.outputs.JAR_NAME }} to /var/www/be/."
              # Xóa thư mục target rỗng sau khi di chuyển file (tùy chọn)
              rmdir target || true # rmdir chỉ xóa thư mục rỗng
            else
              echo "Error: JAR file not found in target/ as expected. Aborting move."
              exit 1
            fi

      - name: Verify JAR copied to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Verifying JAR file on VPS..."
            ls -l /var/www/be/ # Liệt kê nội dung thư mục đích
            # Sau khi di chuyển, file JAR_NAME sẽ nằm trực tiếp trong /var/www/be/
            if [ -f "/var/www/be/${{ steps.get_jar_name.outputs.JAR_NAME }}" ]; then
              echo "JAR file successfully copied and moved to /var/www/be/."
            else
              echo "Error: JAR file NOT found in /var/www/be/ after move operation."
              exit 1 # Thoát workflow nếu không tìm thấy file
            fi
            echo "Verification complete."

      - name: Start Application on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/be || { echo "Error: /var/www/be directory not found on VPS."; exit 1; }

            # Dòng này bây giờ sẽ dùng JAR_NAME đã được làm sạch từ step get_jar_name
            # Nó đã được di chuyển ra ngoài thư mục target bởi bước 'Move JAR from target/ to root'
            NEW_JAR_FULL_NAME=${{ steps.get_jar_name.outputs.JAR_NAME }}
            if [ -z "$NEW_JAR_FULL_NAME" ]; then
              echo "Error: No JAR file name available from previous steps. Deployment failed."
              exit 1
            fi
            mv "$NEW_JAR_FULL_NAME" be.jar
            echo "Renamed $NEW_JAR_FULL_NAME to be.jar"

            echo "Exporting environment variables..."
            export SPRING_DATASOURCE_URL="${{ secrets.DB_URL }}"
            export SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}"
            export SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT="org.hibernate.dialect.MySQL8Dialect"
            export SPRING_JPA_HIBERNATE_DDL_AUTO="update"
            export SPRING_MAIN_ALLOW_CIRCULAR_REFERENCES="true"
            export SPRING_MVC_PATHMATCH_MATCHING_STRATEGY="ANT_PATH_MATCHER"
            export SUPABASE_JWT_SECRET="${{ secrets.SUPABASE_JWT_SECRET_KEY }}"
            export SPRING_SECRETKEY="${{ secrets.SPRING_APP_SECRET_KEY }}"
            export SPRING_KAFKA_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}"
            export KAFKA_TOPIC_NAME="${{ secrets.KAFKA_TOPIC }}"
            export SPRING_MAIL_HOST="${{ secrets.MAIL_HOST }}"
            export SPRING_MAIL_PORT="${{ secrets.MAIL_PORT }}"
            export SPRING_MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            export SPRING_MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH="true"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE="true"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED="true"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_CONNECTIONTIMEOUT="5000"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_TIMEOUT="5000"
            export SPRING_MAIL_PROPERTIES_MAIL_SMTP_WRITETIMEOUT="5000"
            export SPRING_MAIL_DEFAULT_ENCODING="UTF-8"
            export SPRING_DATA_REDIS_HOST="${{ secrets.REDIS_HOST }}"
            export SPRING_DATA_REDIS_PORT="${{ secrets.REDIS_PORT }}"
            export SPRING_CACHE_TYPE="redis"
            export SPRING_DURATION="${{ secrets.APP_DURATION }}"
            export SPRING_PROFILES_ACTIVE="prod"

            echo "Starting new application instance..."
            nohup java -jar be.jar > application.log 2>&1 &
            echo "Application started. Check logs on VPS with 'tail -f /var/www/be/application.log'"